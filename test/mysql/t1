import pymysql
import json

codes_list = []
res = []
conn = pymysql.connect(host='192.168.1.35', user='root', password='greAtsoft918!', db='area_report_platform_test_cn')
mycursor = conn.cursor()


def get_ope_codes():
    sql = "SELECT CODE FROM basic_data WHERE TYPE=%s AND sec_type IN (%s,%s)"
    mycursor.execute(sql, ('OPERATION_CODE', '手术', '介入治疗'))
    datas = mycursor.fetchall()
    for rows in datas:
        codes = rows[0]
        codes_list.append(codes)
    conn.commit()


def get_mr_ope_result():
    sql = 'SELECT mr_content FROM mrqc_result '
    ddd = mycursor.execute(sql)
    datas = mycursor.fetchall()
    for rows in datas:
        json_data = rows[0]
        json_obj = json.loads(str(json_data))
        operations = json_obj['operations']
        if len(operations) > 0:
            a48 = json_obj['a48']
            count_ope = 0
            opes = []
            for ope in operations:
                if ('c35c' in ope):
                    print(ope['c35c'])
                    if str(ope['c35c']) in codes_list:
                        count_ope = count_ope + 1
                        opes.append(str(ope['c35c']))
            dict_ope = {'病案号': a48, '符合条件手术量': count_ope, '符合条件手术代码': opes}
            if count_ope > 0:
                res.append(dict_ope)
    conn.commit()
    mycursor.close()
    conn.close()


get_ope_codes()
print(codes_list)
get_mr_ope_result()
print(res)
