import pymysql
import json

codes_list = []
conn = pymysql.connect(host='192.168.1.35', user='root', password='greAtsoft918!', db='area_report_platform_test_cn')
mycursor = conn.cursor()
sql = "delete from mr_ope_rec"
mycursor.execute(sql)
conn.commit()

def get_ope_codes():
    sql = "SELECT CODE FROM basic_data WHERE TYPE=%s AND sec_type IN (%s,%s)"
    mycursor.execute(sql, ('OPERATION_CODE', '手术', '介入治疗'))
    datas = mycursor.fetchall()
    for rows in datas:
        codes = rows[0]
        codes_list.append(codes)
    conn.commit()


def get_mr_ope_result():
    sql = 'SELECT date,mr_content FROM mrqc_result WHERE LEFT(DATE,7) IN (%s,%s)  AND org_id = %s'
    ddd = mycursor.execute(sql,('2020-01','2020-08','130000200008'))
    datas = mycursor.fetchall()
    for rows in datas:
        date = rows[0]
        json_data = rows[1]
        json_obj = json.loads(str(json_data))
        operations = json_obj['operations']
        i = 1
        if len(operations) > 0:
            a48 = json_obj['a48']
            count_ope = 0
            opes = []
            for ope in operations:
                if ('c35c' in ope):
                    if str(ope['c35c']) in codes_list:
                        count_ope = count_ope + 1
                        opes.append(str(ope['c35c']))
            dict_ope = {'病案号': a48, '符合条件手术量': count_ope, '符合条件手术代码': opes}
            if count_ope > 0:
                sql1 = 'INSERT INTO area_report_platform_test_cn.mr_ope_rec ( a48,date, ope_count, opes) VALUES(%s,%s,%s,%s)'
                mycursor.execute(sql1, (str(a48),date, str(count_ope), str(opes)))
    conn.commit()
    mycursor.close()
    conn.close()


get_ope_codes()
get_mr_ope_result()
